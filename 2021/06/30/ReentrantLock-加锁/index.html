<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="ä»RerentrantLockçš„åŠ é”ï¼Œæ¥çœ‹çœ‹AQSçš„ç›¸å…³æ–¹æ³•å®ç°.">
<meta property="og:type" content="article">
<meta property="og:title" content="ReentrantLock-åŠ é”">
<meta property="og:url" content="http://yoursite.com/2021/06/30/ReentrantLock-%E5%8A%A0%E9%94%81/index.html">
<meta property="og:site_name" content="llrrbaba">
<meta property="og:description" content="ä»RerentrantLockçš„åŠ é”ï¼Œæ¥çœ‹çœ‹AQSçš„ç›¸å…³æ–¹æ³•å®ç°.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-06-30T14:42:45.449Z">
<meta property="article:modified_time" content="2021-06-29T05:11:02.000Z">
<meta property="article:author" content="llrrbaba">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/06/30/ReentrantLock-åŠ é”/"/>





  <title>ReentrantLock-åŠ é” | llrrbaba</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">llrrbaba</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-é¦–é¡µ">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-å…³äº">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      
        
        <li class="menu-item menu-item-æ ‡ç­¾">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-åˆ†ç±»">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-å½’æ¡£">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/30/ReentrantLock-%E5%8A%A0%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="llrrbaba">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="llrrbaba">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ReentrantLock-åŠ é”</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-06-30T22:42:45+08:00">
                2021-06-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>ä»RerentrantLockçš„åŠ é”ï¼Œæ¥çœ‹çœ‹AQSçš„ç›¸å…³æ–¹æ³•å®ç°.</p>
<a id="more"></a>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock#lock</span></span><br><span class="line"><span class="comment">// è·å–é”</span></span><br><span class="line"><span class="comment">// å¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰é”çš„è¯ï¼Œå½“å‰çº¿ç¨‹è·å¾—é”ï¼Œè®¾ç½®stateä¸º1</span></span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹å·²ç»æŒæœ‰é”çš„è¯ï¼Œç”±äºå¯é‡å…¥é”ï¼Œstate+1</span></span><br><span class="line"><span class="comment">// å¦‚æœé”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€(æœ‰çš„åœ°æ–¹ä¹Ÿè¯´çº¿ç¨‹è¢«â€œæŒ‚èµ·â€)ï¼Œä¸èƒ½è¢«CPUè°ƒåº¦ï¼Œç›´åˆ°è·å–åˆ°é”</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.lock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock.Sync#lock</span></span><br><span class="line"><span class="comment">// è¿™æ˜¯ReentrantLockçš„å†…éƒ¨ç±»Syncçš„lockæ–¹æ³•ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“å®ç°åœ¨</span></span><br><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock.NonfairSync#lock å’Œ</span></span><br><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock.FairSync#lock é‡Œ</span></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock#ReentrantLock()</span></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå¯é‡å…¥é”ï¼Œé»˜è®¤æ˜¯éå…¬å¹³çš„å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync = <span class="keyword">new</span> NonfairSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock#ReentrantLock(boolean)</span></span><br><span class="line"><span class="comment">// æˆ‘ä»¬å¯ä»¥è‡ªè¡ŒæŒ‡å®šé”å®ç°ï¼Œæ˜¯å…¬å¹³è¿˜æ˜¯éå…¬å¹³çš„</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock.NonfairSync#lock</span></span><br><span class="line"><span class="comment">// å…ˆçœ‹çœ‹éå…¬å¹³é”çš„å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// ä¸Šæ¥å…ˆå°è¯•æ’é˜Ÿ</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">      	<span class="comment">// å¦‚æœæ’é˜ŸæˆåŠŸï¼Œè®¾ç½®java.util.concurrent.locks.AbstractOwnableSynchronizer#exclusiveOwnerThreadå±æ€§</span></span><br><span class="line">      	<span class="comment">// å£°ç§°è‡ªå·±è·å¾—äº†é”</span></span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      	<span class="comment">// å¦‚æœæ’é˜Ÿä¸æˆåŠŸï¼Œè€è€å®å®æ’é˜Ÿå»</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock.FairSync#lock</span></span><br><span class="line"><span class="comment">// å¯¹æ¯”ä¸Šé¢çš„éå…¬å¹³é”ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…¬å¹³é”ï¼Œæ²¡æœ‰æ’é˜Ÿçš„ç¯èŠ‚ï¼Œç›´æ¥å°±æ˜¯å»è€è€å®å®æ’é˜Ÿå»</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.AbstractQueuedSynchronizer#acquire</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// 1.é¦–å…ˆå°è¯•è·å–ä¸‹é”ï¼Œ</span></span><br><span class="line">  	<span class="comment">//		1.1å¦‚æœè·å–é”æˆåŠŸï¼Œæ‰§è¡Œè·å–é”åçš„æ“ä½œ </span></span><br><span class="line">  	<span class="comment">// 		1.2å¦‚æœæ²¡æœ‰è·å–é”æˆåŠŸï¼Œæ‰§è¡Œä¸‹è¾¹çš„æ“ä½œ</span></span><br><span class="line">  	<span class="comment">// 2.å°±å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—é‡Œ</span></span><br><span class="line">  	<span class="comment">// 3.æ‰§è¡Œå®Œ1å’Œ2åï¼Œä¹Ÿå°±æ˜¯å°è¯•è·å–é”å¤±è´¥ï¼Œå¹¶ä¸”å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—é‡Œåï¼Œä¸­æ–­è‡ªå·±ï¼ŸTODO</span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock.NonfairSync#tryAcquire</span></span><br><span class="line"><span class="comment">// é¦–å…ˆçœ‹çœ‹éå…¬å¹³é”çš„ tryAcquire å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock.Sync#nonfairTryAcquire</span></span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªéå…¬å¹³åœ°å°è¯•è·å–é”çš„æ–¹æ³•ï¼Œå†™åˆ°äº†Syncé‡Œï¼Œè€Œä¸æ˜¯NonfairSyncé‡Œï¼Œ</span></span><br><span class="line"><span class="comment">// ä¸ºå•¥å˜ï¼Œå› ä¸ºjava.util.concurrent.locks.ReentrantLock#tryLock()ä¹Ÿæ˜¯ç”¨çš„è¿™ä¸ªéå…¬å¹³çš„æ–¹å¼ï¼Œå°è¯•è·å–é”</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">  	<span class="comment">// å¯ä»¥çœ‹åˆ°ï¼Œéå…¬å¹³çš„å°è¯•åŠ é”æ“ä½œï¼Œå’Œéå…¬å¹³çš„åŠ é”(java.util.concurrent.locks.ReentrantLock.NonfairSync#lock)æœ‰ç‚¹ç±»ä¼¼ï¼Œ</span></span><br><span class="line">  	<span class="comment">// éƒ½æ˜¯ä¸Šæ¥å…ˆæ’ä¸ªé˜Ÿï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‹¿åˆ°é”</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">      	<span class="comment">// å¦‚æœstate==0ï¼Œå°è¯•ç”¨CASçš„æ–¹å¼è·å–é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">          	<span class="comment">// å¦‚æœè·å–é”æˆåŠŸåï¼Œè®¾ç½®ç‹¬å çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">          	<span class="comment">// å¹¶è¿”å›trueï¼Œæ ‡æ˜è·å–é”æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">      	<span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹å°±æ˜¯ç‹¬å çº¿ç¨‹ï¼Œå°±ç»™stateåŠ ä¸Šacquires</span></span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">          	<span class="comment">// int æœ€å¤§å€¼æ˜¯â€œ2147483647â€ï¼Œå¦‚æœâ€œ2147483647+1â€çš„è¯ï¼Œå°±æ˜¯â€œ-2147483648â€äº†</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">      	<span class="comment">// æ›´æ–°stateå€¼</span></span><br><span class="line">        setState(nextc);</span><br><span class="line">      	<span class="comment">// å¹¶è¿”å›trueï¼Œæ ‡æ˜è·å–é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock#tryLock()</span></span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœç›´æ¥è°ƒç”¨tryLockçš„è¯ï¼Œå®ç°æ˜¯èµ°çš„éå…¬å¹³çš„ç‰ˆæœ¬å“¦</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sync.nonfairTryAcquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.ReentrantLock.FairSync#tryAcquire</span></span><br><span class="line"><span class="comment">// çœ‹ä¸‹FairSyncçš„å®ç°ç‰ˆæœ¬ï¼Œ</span></span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°ï¼Œåœ¨state == 0çš„æ—¶å€™ï¼Œå…¬å¹³é”çš„å®ç°æ¯”éå…¬å¹³é”çš„å®ç°ï¼Œå¤šä¸€ä¸ªhasQueuedPredecessorsçš„åˆ¤æ–­ï¼Œä»…æ­¤è€Œå·²</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">  	<span class="comment">// è·å–å…¬å¹³é”çš„åŒæ­¥çŠ¶æ€ï¼Œè¿™é‡Œä¼šè°ƒç”¨aqsçš„getState()æ–¹æ³•</span></span><br><span class="line">  	<span class="comment">// å› ä¸ºjucåŒ…ä¸‹çš„å¤§éƒ¨åˆ†ç±»éƒ½ä¼šç”¨åˆ°aqsçš„åŒæ­¥çŠ¶æ€stateï¼Œæ¥å®ç°ç‰¹å®šçš„åŠŸèƒ½</span></span><br><span class="line">  	<span class="comment">// state == 0ï¼Œè¯´æ˜å½“å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰è¯¥é”</span></span><br><span class="line">  	<span class="comment">// state &gt; 0ï¼Œè¯´æ˜å½“å‰æœ‰çº¿ç¨‹æŒæœ‰è¯¥é”ï¼ŒæŒæœ‰è¯¥é”çš„çº¿ç¨‹å¯èƒ½å°±æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">      	<span class="comment">// å¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰è¯¥é”çš„è¯ï¼Œ</span></span><br><span class="line">      	<span class="comment">// 1.å› ä¸ºæ˜¯å…¬å¹³é”ï¼Œå…ˆåˆ°å…ˆå¾—ï¼Œæ‰€ä»¥è¦æŸ¥çœ‹æœ‰æ²¡æœ‰æ¯”å½“å‰çº¿ç¨‹ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹åœ¨ç­‰å¾…é”</span></span><br><span class="line">      	<span class="comment">//		1.1å¦‚æœæœ‰æ¯”å½“å‰çº¿ç¨‹ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€æŠŠé”ï¼Œå°è¯•è·å–é”å¤±è´¥ï¼Œè¿”å›false</span></span><br><span class="line">      	<span class="comment">//		1.2å¦‚æœæ²¡æœ‰æ¯”å½“å‰çº¿ç¨‹ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€æŠŠé”ï¼Œç»§ç»­ä¸‹ä¸€æ­¥æ“ä½œ</span></span><br><span class="line">      	<span class="comment">// 2.é€šè¿‡CASçš„æ–¹å¼ï¼Œå»è®¾ç½®stateï¼Œè¿™é‡Œçš„acquireså°±æ˜¯æœ€å¼€å§‹çš„FairSync#lockæ–¹æ³•é‡Œçš„acruire(1)é‡Œçš„1</span></span><br><span class="line">      	<span class="comment">// 3.å› ä¸ºReentrantLockæœ¬èº«å°±æ˜¯ç‹¬å é”æ¨¡å¼ï¼Œæ‰€ä»¥ï¼Œè®¾ç½®åŒæ­¥çŠ¶æ€stateæˆåŠŸåï¼Œè¦å»è®¾ç½®ä¸‹å°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºé”çš„owenerï¼Œå°è¯•è·å–é”æˆåŠŸï¼Œè¿”å›trueï¼Œ</span></span><br><span class="line">        <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">            <span class="comment">// è¿™é‡Œä¸ºå•¥ç”¨casè®¾ç½®stateï¼Œä¸‹é¢43è¡ŒsetStateä¸æ˜¯ç›´æ¥ç”¨çš„setå—ï¼Œæœ‰å•¥åŒºåˆ«å‘¢ï¼Ÿ</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Note that because cancellations due to interrupts and timeouts may occur at any time, </span></span><br><span class="line"><span class="comment">             * a true return does not guarantee that some other thread will acquire before the current </span></span><br><span class="line"><span class="comment">             * thread. Likewise, it is possible for another thread to win a race to enqueue </span></span><br><span class="line"><span class="comment">             * after this method has returned false, due to the queue being empty.</span></span><br><span class="line"><span class="comment">             * è¿™é‡Œæ‘˜ä¸€æ®µhasQueuedPredecessorsæ–¹æ³•çš„æ³¨é‡Šï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåœ¨å½“å‰çº¿ç¨‹çš„hasQueuedPredecessorsæ–¹æ³•è¿”å›trueå¯èƒ½							* æœ‰ä¸¤ç§æƒ…å†µï¼Œ1æ˜¯ç­‰å¾…é˜Ÿåˆ—æœ¬èº«å°±æ˜¯ç©ºçš„ï¼›2æ˜¯å½“å‰çº¿ç¨‹å¯¹åº”çš„èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">             * å¯¹äºç¬¬ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯ç­‰å¾…é˜Ÿåˆ—æœ¬èº«å°±æ˜¯ç©ºçš„ï¼Œé‚£åˆ«çš„çº¿ç¨‹ä¹Ÿå¯èƒ½é€šè¿‡addWaiteræ–¹æ³•ï¼Œç„¶åæ˜¯acquiredQueuedæ–¹æ³•ï¼Œæ¥è®¾						 * ç½®stateçš„ï¼Œæ‰€ä»¥è¿™é‡Œè¦ç”¨casçš„æ–¹å¼è®¾ç½®stateï¼Œå› ä¸ºçœŸçš„æœ‰å¯èƒ½å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">      	<span class="comment">// èµ°åˆ°è¿™é‡Œï¼Œc &gt; 0, è¯´æ˜å½“å‰æœ‰çº¿ç¨‹æŒæœ‰è¯¥é”</span></span><br><span class="line">      	<span class="comment">// å¯¹stateç»´æŠ¤ä¸‹</span></span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">      	<span class="comment">// è®¾ç½®state</span></span><br><span class="line">      	<span class="comment">// è¿™é‡Œå’Œä¸Šé¢29è¡Œå°±ä¸ä¸€æ ·äº†ï¼Œå› ä¸ºè¿™é‡Œè‚¯å®šæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰é”ï¼Œæ‰€ä»¥ä¸æ€•å¹¶å‘é—®é¢˜ï¼Œç›´æ¥setå°±å¥½</span></span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å¦‚æœc==0çš„æ—¶å€™ï¼Œç”±äºå½“å‰çº¿ç¨‹è¿˜æ²¡è·å–åˆ°é”ï¼Œè®¾ç½®stateä½¿ç”¨çš„æ˜¯compareAndSetStateï¼›è€Œcurrent == getExclusiveOwnerThread()çš„æ—¶å€™ï¼Œå½“å‰çº¿ç¨‹å·²ç»è·å–åˆ°é”äº†ï¼Œä¿®æ”¹stateæ˜¯å®‰å…¨çš„ï¼Œè®¾ç½®stateä½¿ç”¨çš„æ˜¯setStateã€‚</p>
<p><strong>å¤šçº¿ç¨‹ä¸‹æ“ä½œçš„æ—¶å€™ï¼Œä¸€å®šè¦ä»”ç»†æƒ³å¥½ï¼Œæƒ³æ˜ç™½ï¼Œæˆ‘ä»¬çš„æ“ä½œæ˜¯å¦æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŸåŒä¸€æ—¶åˆ»æœ‰æ²¡æœ‰å¯èƒ½å¤šä¸ªçº¿ç¨‹æ‰§è¡ŒæŸä¸€æ®µä»£ç ï¼Ÿ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.AbstractQueuedSynchronizer#hasQueuedPredecessors</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedPredecessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// è·å–ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">    Node t = tail; </span><br><span class="line">  	<span class="comment">// è·å–ç­‰å¾…é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹</span></span><br><span class="line">    Node h = head;</span><br><span class="line">    Node s;</span><br><span class="line">  	<span class="comment">// åˆæ¬¡çœ‹åˆ°è¿™é‡Œï¼Œå·²ç»æ‡µäº†ï¼Œå¦‚æœä¸çŸ¥é“è¿™ä¸ªç­‰å¾…é˜Ÿåˆ—æ€ä¹ˆç»´æŠ¤å¤´å°¾èŠ‚ç‚¹ï¼Œæ€ä¹ˆåˆå§‹åŒ–é˜Ÿåˆ—çš„è¯ï¼Œå¯èƒ½çœ‹è¿™é‡Œæ¯”è¾ƒéš¾å—</span></span><br><span class="line">  	<span class="comment">// å¯ä»¥  å…ˆè·³è¿‡è¿™é‡Œï¼Œçœ‹çœ‹aqsæ˜¯æ€ä¹ˆç»´æŠ¤å®ƒé‡Œé¢çš„ç­‰å¾…é˜Ÿåˆ—çš„ï¼Œå†å›è¿‡å¤´æ¥ğŸ‘€ğŸ‘€</span></span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// çœ‹å®Œä¸‹é¢çš„addWaiterå’Œenqæ–¹æ³•ï¼Œå†æ¥çœ‹çœ‹è¿™é‡Œ</span></span><br><span class="line">  	<span class="comment">// 1.æ ¹æ®ä¸‹é¢enqæ–¹æ³•çš„ç¬¬12è¡Œï¼Œå¯ä»¥å¾—çŸ¥ï¼Œé™¤éæ˜¯åœ¨ç¬¬ä¸€æ¬¡æ’å…¥ç­‰å¾…é˜Ÿåˆ—å…ƒç´ æ—¶ï¼Œåˆå§‹åŒ–å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">  	<span class="comment">//   æ‰ä¼šå‡ºç°è¿™ä¿©èŠ‚ç‚¹æŒ‡å‘åŒä¸€ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼›h != tè¯´æ˜ç­‰å¾…é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œ</span></span><br><span class="line">  	<span class="comment">//   å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œè¯´æ˜è‚¯å®šæ²¡æœ‰æ¯”å½“å‰çº¿ç¨‹ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹åœ¨ç­‰å¾…é”</span></span><br><span class="line">  	<span class="comment">// 2.sä¸ºå¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">  	<span class="comment">//	 2.1å¦‚æœ h != t ï¼Œå¹¶ä¸”å¦‚æœå¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ä¸ºnullçš„è¯ï¼Œ</span></span><br><span class="line">  	<span class="comment">//	    æ ¹æ®ä¸‹é¢acquireQueuedæ–¹æ³•çš„ç¬¬19è¡Œï¼Œå¯ä»¥å¾—çŸ¥ï¼Œå¦‚æœæœ‰åˆ«çš„çº¿ç¨‹è·å–åˆ°é”çš„è¯ï¼Œä¼šå°†h.nextè®¾ç½®ä¸ºnullï¼Œ</span></span><br><span class="line">  	<span class="comment">//			Nodeçš„nextå±æ€§æ˜¯volatileçš„ï¼Œçº¿ç¨‹å¯è§çš„ï¼Œæ­¤æ—¶ï¼Œå°è¯•è·å–é”å¤±è´¥ï¼›</span></span><br><span class="line">  	<span class="comment">//	 2.2å¦‚æœ h != t ï¼Œå¹¶ä¸”å¦‚æœå¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çš„threadæ˜¯å½“å‰çº¿ç¨‹çš„è¯ï¼Œå°è¯•è·å–é”æˆåŠŸã€‚</span></span><br><span class="line">  	<span class="comment">// ç¿»è¯‘ç¿»è¯‘ï¼Œå°±æ˜¯å¦‚æœ</span></span><br><span class="line">  	<span class="comment">// 1.ç­‰å¾…é˜Ÿåˆ—åˆšåˆšåˆå§‹åŒ–(head == tail == new Node())æˆ–è€…ç­‰å¾…é˜Ÿåˆ—ä¸ºç©º(head == tail == null)ï¼Œè‚¯å®šæ˜¯å¯ä»¥çš„ï¼Œè¯´æ˜æ²¡æœ‰æ¯”å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´æ›´é•¿</span></span><br><span class="line">  	<span class="comment">// 2.å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä¹Ÿæ²¡é—®é¢˜ï¼Œåªè¦å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå¹¶ä¸”åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å°±æ˜¯å½“å‰çº¿ç¨‹ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¹Ÿè¯´æ˜å½“å‰çº¿ç¨‹æ’é˜Ÿæ’åˆ°ç¬¬ä¸€ä½äº†ï¼Œæ²¡æœ‰æ¯”å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´æ›´ä¹…çš„çº¿ç¨‹äº†</span></span><br><span class="line">  	<span class="comment">/**</span></span><br><span class="line"><span class="comment">  	 * Returns:</span></span><br><span class="line"><span class="comment">		 * true if there is a queued thread preceding the current thread, and false if the current thread is at 		 </span></span><br><span class="line"><span class="comment">		 * the head of the queue or the queue is empty</span></span><br><span class="line"><span class="comment">		 * è¿™é‡ŒæŠŠå®˜æ–¹å¯¹äºreturnä¸ºtrueçš„æ³¨é‡Šç²˜è¿‡æ¥ï¼Œå¤§å®¶å¯ä»¥çœ‹çœ‹</span></span><br><span class="line"><span class="comment">  	 */</span></span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">        ((s = h.next) == <span class="keyword">null</span> || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.AbstractQueuedSynchronizer#getFirstQueuedThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Thread <span class="title">getFirstQueuedThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// handle only fast path, else relay</span></span><br><span class="line">    <span class="keyword">return</span> (head == tail) ? <span class="keyword">null</span> : fullGetFirstQueuedThread();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.AbstractQueuedSynchronizer#addWaiter</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// æ„å»ºä¸€ä¸ªç‹¬å æ¨¡å¼çš„èŠ‚ç‚¹ï¼Œå…³è”å½“å‰çº¿ç¨‹</span></span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">  	<span class="comment">/**</span></span><br><span class="line"><span class="comment">  	 * è¿™é‡Œç²˜ä¸€æ®µNodeçš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°é€šè¿‡ addWaiter æ–¹æ³•æ·»åŠ çš„ç‹¬å èŠ‚ç‚¹ï¼Œçš„ nextWaiter æ˜¯ null</span></span><br><span class="line"><span class="comment">  	 * static final Node EXCLUSIVE = null;</span></span><br><span class="line"><span class="comment">  	 * Node(Thread thread, Node mode) &#123;     // Used by addWaiter</span></span><br><span class="line"><span class="comment">     *			this.nextWaiter = mode;</span></span><br><span class="line"><span class="comment">     *		this.thread = thread;</span></span><br><span class="line"><span class="comment">		 * &#125;</span></span><br><span class="line"><span class="comment">  	 */</span></span><br><span class="line">    <span class="comment">// å°†predèŠ‚ç‚¹æŒ‡å‘å°¾èŠ‚ç‚¹</span></span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">      	<span class="comment">// å¦‚æœå°¾èŠ‚ç‚¹ä¸æ˜¯nullï¼Œå°†æ–°æ’å…¥çš„èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘åŸå…ˆçš„å°¾èŠ‚ç‚¹</span></span><br><span class="line">        node.prev = pred;</span><br><span class="line">      	<span class="comment">// é€šè¿‡casçš„æ–¹å¼è®¾ç½®æ–°çš„å°¾èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">          	<span class="comment">// å¦‚æœè®¾ç½®æ–°çš„å°¾èŠ‚ç‚¹æˆåŠŸï¼Œè¯´æ˜æ²¡æœ‰åˆ«çš„çº¿ç¨‹å…ˆäºå½“å‰çº¿ç¨‹æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—é‡Œï¼Œå¹¶è¢«è®¾ç½®ä¸ºäº†å°¾èŠ‚ç‚¹</span></span><br><span class="line">          	<span class="comment">// å°†åŸå…ˆçš„å°¾èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æŒ‡å‘æ–°æ’å…¥çš„èŠ‚ç‚¹ï¼Œç­‰å¾…é˜Ÿåˆ—æ„æˆåŒå‘é“¾è¡¨</span></span><br><span class="line">            pred.next = node;</span><br><span class="line">          	<span class="comment">// è¿”å›æ–°æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œï¼Œåªæœ‰ä¸¤ç§æƒ…å†µ</span></span><br><span class="line">  	<span class="comment">// 1.å¦‚æœåŸå…ˆçš„å°¾èŠ‚ç‚¹å°±æ˜¯nullï¼Œè¯´æ˜è¿™ä¸ªåŒæ­¥é˜Ÿåˆ—(sync queue)æ˜¯ä¸ªç©ºçš„é˜Ÿåˆ—</span></span><br><span class="line">  	<span class="comment">// 2.11è¡Œçš„compareAndSetTailæ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼Œå› ä¸ºå¯èƒ½åŒæ—¶æœ‰å¤šä¸ªçº¿ç¨‹éƒ½åœ¨å°è¯•å…¥é˜Ÿï¼Œå…¶ä»–çº¿ç¨‹å…¥é˜ŸæˆåŠŸï¼Œé‚£å½“å‰çº¿ç¨‹å…¥é˜Ÿå¤±è´¥ï¼Œå°±èµ°åˆ°è¿™é‡Œäº†</span></span><br><span class="line">    enq(node);</span><br><span class="line">  	<span class="comment">// è¿”å›æ–°æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.AbstractQueuedSynchronizer#enq</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// é€šè¿‡ for(;;) çš„å½¢å¼ï¼Œå®ç°è‡ªæ—‹ï¼Œå› ä¸ºä¸‹é¢19è¡Œçš„compareAndSetTailå¯èƒ½æ‰§è¡Œä¸æˆåŠŸï¼Œéœ€è¦è‡ªæ—‹ï¼Œå†æ¬¡è¿›è¡Œå…¥é˜Ÿã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      	<span class="comment">// è·å–åŸå…ˆçš„å°¾èŠ‚ç‚¹</span></span><br><span class="line">        Node t = tail;</span><br><span class="line">      	<span class="comment">// å¦‚æœåŸå…ˆçš„å°¾èŠ‚ç‚¹ä¸ºnullï¼Œè¯´æ˜ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸ªç©ºé˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">          	<span class="comment">// åˆå§‹åŒ–ç­‰å¾…é˜Ÿåˆ—ï¼Œé€šè¿‡casçš„æ–¹å¼è®¾ç½®ä¸€ä¸ªå¤´èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹æ˜¯ä¸ªç©ºèŠ‚ç‚¹(ä¹Ÿæœ‰ç®¡è¿™ä¸ªé¦–èŠ‚ç‚¹å«å“¨å…µèŠ‚ç‚¹çš„)ï¼Œæ²¡æœ‰çº¿ç¨‹ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">              	<span class="comment">// å°†å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹æŒ‡å‘åŒä¸€ä¸ªèŠ‚ç‚¹--å³åˆšåˆšåˆå§‹åŒ–çš„ç©ºèŠ‚ç‚¹</span></span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          	<span class="comment">// å¦‚æœåŸå…ˆçš„å°¾èŠ‚ç‚¹ä¸ä¸ºnullï¼Œè¯´æ˜ç­‰å¾…é˜Ÿåˆ—ä¸æ˜¯ç©ºé˜Ÿåˆ—</span></span><br><span class="line">          	<span class="comment">// å°†æ–°æ’å…¥èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘åŸå…ˆçš„å°¾èŠ‚ç‚¹</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">          	<span class="comment">// é€šè¿‡casçš„æ–¹å¼è®¾ç½®å°¾èŠ‚ç‚¹</span></span><br><span class="line">          	<span class="comment">// å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œåªæ˜¯ä¼šå°†æ–°çš„èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„å°¾èŠ‚ç‚¹ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ“ä½œå¤´èŠ‚ç‚¹ï¼Œå¤´èŠ‚ç‚¹æ°¸è¿œéƒ½æ˜¯ä¸€ä¸ªç©ºèŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">              	<span class="comment">// å¦‚æœè®¾ç½®å°¾èŠ‚ç‚¹æˆåŠŸï¼Œè¯´æ˜æ²¡æœ‰åˆ«çš„çº¿ç¨‹å…ˆäºå½“å‰çº¿ç¨‹æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—é‡Œï¼Œå¹¶è¢«è®¾ç½®ä¸ºäº†å°¾èŠ‚ç‚¹</span></span><br><span class="line">                t.next = node;</span><br><span class="line">              	<span class="comment">// å°†æ’å…¥èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯åŸå…ˆçš„å°¾èŠ‚ç‚¹è¿”å›</span></span><br><span class="line">              	<span class="comment">// èµ°åˆ°è¿™é‡Œï¼Œå°±ç®—å…¥é˜ŸæˆåŠŸäº†ï¼Œåœæ­¢è‡ªæ—‹</span></span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.AbstractQueuedSynchronizer#acquireQueued</span></span><br><span class="line"><span class="comment">// æ’é˜Ÿç­‰å¾…è·å–é”</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">      	<span class="comment">// åˆæ¥éå†ä¸€éç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">          	<span class="comment">// ä»åå¾€å‰éå†</span></span><br><span class="line">          	<span class="comment">// ä¸ºå•¥ä»åå¾€å‰éå†å‘¢ï¼Ÿ</span></span><br><span class="line">          	<span class="comment">// è·å–åˆšåˆšé€šè¿‡addWaiteræ’å…¥åˆ°é˜Ÿåˆ—çš„èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">          	<span class="comment">// ä¸æ–­å¾€å‰éå†ï¼Œç›´åˆ°æ‰¾åˆ°æŸä¸€ä¸ªé˜Ÿåˆ—çš„èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">          	<span class="comment">// å°±å»å°è¯•è·å–é”ï¼Œå¦‚æœå°è¯•è·å–é”æˆåŠŸçš„è¯ï¼Œ</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">              	<span class="comment">// å°†å¤´èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                setHead(node);</span><br><span class="line">              	<span class="comment">// å°†åŸå…ˆçš„å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹è®¾ç½®ä¸ºnullï¼Œ</span></span><br><span class="line">              	<span class="comment">// å…¶å®å°±æ˜¯å°†åŸå…ˆçš„å¤´èŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­æ’‡æ‰ï¼Œggäº†</span></span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">              	<span class="comment">// è·å–é”æˆåŠŸ</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">// èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜ï¼Œå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">          	<span class="comment">// æˆ–è€…ï¼Œå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œä½†æ˜¯tryAcquire(è·å–åŒæ­¥çŠ¶å¤±è´¥äº†ï¼Œè¢«æ’é˜Ÿäº†å‘—)å¤±è´¥äº†</span></span><br><span class="line">          	<span class="comment">// å¦‚æœ shouldParkAfterFailedAcquire è¿”å› falseï¼Œé‚£ä¹ˆè¿›å…¥è‡ªæ—‹ï¼Œå†æ¥ä¸€æ¬¡ï¼Œçœ‹çœ‹å½“å‰èŠ‚ç‚¹çš„å‰äº”èŠ‚ç‚¹æœ‰æ²¡æœ‰å˜æˆheadèŠ‚ç‚¹</span></span><br><span class="line">          	<span class="comment">// å¦‚æœ shouldParkAfterFailedAcquire è¿”å› trueï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒç”¨ parkAndCheckInterrupt å°†å½“å‰çº¿ç¨‹æŒ‚èµ·äº†ï¼Œ for(;;)ä¹Ÿå°±åœæ­¢äº†</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      	<span class="comment">// å¦‚æœèƒ½èµ°åˆ°è¿™é‡Œçš„è¯ï¼Œè¯´æ˜ï¼Œä¸Šé¢åº”è¯¥æ˜¯æŠ›å‡ºå¼‚å¸¸äº†</span></span><br><span class="line">      	<span class="comment">// 12è¡Œnode.predecessor()åŠ15è¡ŒtryAcquireï¼Œéƒ½æœ‰å¯èƒ½æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">      	<span class="comment">// if (nextc &lt; 0) // overflow</span></span><br><span class="line">        <span class="comment">//            throw new Error("Maximum lock count exceeded");</span></span><br><span class="line">      	<span class="comment">// ä¸Šé¢è¿™ä¸ªå¼‚å¸¸ï¼Œæ˜¯tryAcquireå¯èƒ½ä¼šæŠ›å‡ºçš„å¼‚å¸¸ï¼Œä¸€èˆ¬ä¹Ÿä¸ä¼šèµ°åˆ°è¿™é‡Œå§ï¼Œèµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜é‡å…¥æ¬¡æ•°ä¹Ÿå¤ªå¤šäº†å§</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.AbstractQueuedSynchronizer.Node#waitStatus</span></span><br><span class="line"><span class="comment">// æˆ‘ä»¬è¿™é‡Œæ¥çœ‹ä¸‹è¿™ä¸ª ç­‰å¾…çŠ¶æ€</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL    = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONDITION = -<span class="number">2</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROPAGATE = -<span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ‘˜ä¸€æ®µä¸€ä¸ªå¤§ä½¬è®²çš„<a href="https://segmentfault.com/a/1190000015739343" target="_blank" rel="noopener">æ–‡ç« </a></p>
<blockquote>
<p>ä¸€å…±æœ‰å››ç§çŠ¶æ€ï¼Œåœ¨ç‹¬å é”é”çš„è·å–æ“ä½œä¸­ï¼Œæˆ‘ä»¬åªç”¨åˆ°äº†å…¶ä¸­çš„ä¸¤ä¸ªâ€”â€”<code>CANCELLED</code>å’Œ<code>SIGNAL</code>ã€‚<br>å½“ç„¶ï¼Œå‰é¢æˆ‘ä»¬åœ¨åˆ›å»ºèŠ‚ç‚¹çš„æ—¶å€™å¹¶æ²¡æœ‰ç»™waitStatusèµ‹å€¼ï¼Œå› æ­¤æ¯ä¸€ä¸ªèŠ‚ç‚¹æœ€å¼€å§‹çš„æ—¶å€™waitStatusçš„å€¼éƒ½è¢«åˆå§‹åŒ–ä¸º0ï¼Œå³ä¸å±äºä¸Šé¢ä»»ä½•ä¸€ç§çŠ¶æ€ã€‚</p>
<p>é‚£ä¹ˆ<code>CANCELLED</code>å’Œ<code>SIGNAL</code>ä»£è¡¨ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p>
<p><code>CANCELLED</code>çŠ¶æ€å¾ˆå¥½ç†è§£ï¼Œå®ƒè¡¨ç¤ºNodeæ‰€ä»£è¡¨çš„å½“å‰çº¿ç¨‹å·²ç»å–æ¶ˆäº†æ’é˜Ÿï¼Œå³æ”¾å¼ƒè·å–é”äº†ã€‚</p>
<p><code>SIGNAL</code>è¿™ä¸ªçŠ¶æ€å°±æœ‰ç‚¹æ„æ€äº†ï¼Œå®ƒä¸æ˜¯è¡¨å¾å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œè€Œæ˜¯å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ã€‚<br>å½“ä¸€ä¸ªèŠ‚ç‚¹çš„waitStatusè¢«ç½®ä¸º<code>SIGNAL</code>ï¼Œå°±è¯´æ˜å®ƒçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå³å®ƒçš„åç»§èŠ‚ç‚¹ï¼‰å·²ç»è¢«æŒ‚èµ·äº†ï¼ˆæˆ–è€…é©¬ä¸Šå°±è¦è¢«æŒ‚èµ·äº†ï¼‰ï¼Œå› æ­¤åœ¨å½“å‰èŠ‚ç‚¹é‡Šæ”¾äº†é”æˆ–è€…æ”¾å¼ƒè·å–é”æ—¶ï¼Œå¦‚æœå®ƒçš„waitStatuså±æ€§ä¸º<code>SIGNAL</code>ï¼Œå®ƒè¿˜è¦å®Œæˆä¸€ä¸ªé¢å¤–çš„æ“ä½œâ€”â€”å”¤é†’å®ƒçš„åç»§èŠ‚ç‚¹ã€‚</p>
<p>æœ‰æ„æ€çš„æ˜¯ï¼Œ<code>SIGNAL</code>è¿™ä¸ªçŠ¶æ€çš„è®¾ç½®å¸¸å¸¸ä¸æ˜¯èŠ‚ç‚¹è‡ªå·±ç»™è‡ªå·±è®¾çš„ï¼Œè€Œæ˜¯åç»§èŠ‚ç‚¹è®¾ç½®çš„ï¼Œè¿™é‡Œç»™å¤§å®¶æ‰“ä¸ªæ¯”æ–¹ï¼š</p>
<p>æ¯”å¦‚è¯´å‡ºå»åƒé¥­ï¼Œåœ¨äººå¤šçš„æ—¶å€™ç»å¸¸è¦æ’é˜Ÿå–å·ï¼Œä½ å–åˆ°äº†8å·ï¼Œå‰é¢è¿˜æœ‰7ä¸ªäººåœ¨ç­‰ç€è¿›å»ï¼Œä½ å°±å’Œæ’åœ¨ä½ å‰é¢çš„7å·è®²â€œå“¥ä»¬ï¼Œæˆ‘ç°åœ¨æ’åœ¨ä½ åé¢ï¼Œé˜Ÿä¼è¿™ä¹ˆé•¿ï¼Œä¼°è®¡ä¸€æ—¶åŠä¼šå„¿ä¹Ÿè½®ä¸åˆ°æˆ‘ï¼Œæˆ‘å»é‚£è¾¹æ‰“ä¸ªç›¹ï¼Œä¸€ä¼šè½®åˆ°ä½ è¿›å»äº†(release)æˆ–è€…ä½ ä¸æƒ³ç­‰äº†(cancel), éº»çƒ¦ä½ éƒ½å«é†’æˆ‘â€ï¼Œè¯´å®Œï¼Œä½ å°±æŠŠä»–çš„waitStatuså€¼è®¾æˆäº†<code>SIGNAL</code>ã€‚</p>
<p>æ¢ä¸ªè§’åº¦è®²ï¼Œå½“æˆ‘ä»¬å†³å®šè¦å°†ä¸€ä¸ªçº¿ç¨‹æŒ‚èµ·ä¹‹å‰ï¼Œé¦–å…ˆè¦ç¡®ä¿è‡ªå·±çš„å‰é©±èŠ‚ç‚¹çš„waitStatusä¸º<code>SIGNAL</code>ï¼Œè¿™å°±ç›¸å½“äºç»™è‡ªå·±è®¾ä¸€ä¸ªé—¹é’Ÿå†å»ç¡ï¼Œè¿™ä¸ªé—¹é’Ÿä¼šåœ¨æ°å½“çš„æ—¶å€™å«é†’è‡ªå·±ï¼Œå¦åˆ™ï¼Œå¦‚æœä¸€ç›´æ²¡æœ‰äººæ¥å«é†’è‡ªå·±ï¼Œè‡ªå·±å¯èƒ½å°±ä¸€ç›´ç¡åˆ°å¤©è’åœ°è€äº†ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.AbstractQueuedSynchronizer#shouldParkAfterFailedAcquire</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// è·å–åˆšåˆšé€šè¿‡addWaiteræ’å…¥é˜Ÿåˆ—çš„èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ï¼ŒwaitStatus</span></span><br><span class="line">  	<span class="comment">// TODO è¿™é‡Œåˆçœ‹ä¸æ‡‚äº†ï¼Œå»çœ‹çœ‹aqsæ€ä¹ˆç»´æŠ¤waitStatusçš„ï¼Œå†å›æ¥ğŸ‘€ğŸ‘€</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This node has already set status asking a release</span></span><br><span class="line"><span class="comment">         * to signal it, so it can safely park.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">      	<span class="comment">// å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€å·²ç»æ˜¯SIGNALäº†ï¼Œè¯´æ˜é—¹é’Ÿå·²ç»è®¾äº†ï¼Œå¯ä»¥ç›´æ¥ç¡äº†</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Predecessor was cancelled. Skip over predecessors and</span></span><br><span class="line"><span class="comment">         * indicate retry.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">      	<span class="comment">// å½“å‰èŠ‚ç‚¹çš„ ws &gt; 0, åˆ™ä¸º Node.CANCELLED è¯´æ˜å‰é©±èŠ‚ç‚¹å·²ç»å–æ¶ˆäº†ç­‰å¾…é”(ç”±äºè¶…æ—¶æˆ–è€…ä¸­æ–­ç­‰åŸå› )</span></span><br><span class="line">        <span class="comment">// æ—¢ç„¶å‰é©±èŠ‚ç‚¹ä¸ç­‰äº†, é‚£å°±ç»§ç»­å¾€å‰æ‰¾, ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªè¿˜åœ¨ç­‰å¾…é”çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// ç„¶åæˆ‘ä»¬è·¨è¿‡è¿™äº›ä¸ç­‰å¾…é”çš„èŠ‚ç‚¹, ç›´æ¥æ’åœ¨ç­‰å¾…é”çš„èŠ‚ç‚¹çš„åé¢ (æ˜¯ä¸æ˜¯å¾ˆå¼€å¿ƒ!!!)</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * waitStatus must be 0 or PROPAGATE.  Indicate that we</span></span><br><span class="line"><span class="comment">         * need a signal, but don't park yet.  Caller will need to</span></span><br><span class="line"><span class="comment">         * retry to make sure it cannot acquire before parking.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">      	<span class="comment">// å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€æ—¢ä¸æ˜¯SIGNALï¼Œä¹Ÿä¸æ˜¯CANCELLED</span></span><br><span class="line">        <span class="comment">// ç”¨CASè®¾ç½®å‰é©±èŠ‚ç‚¹çš„wsä¸º Node.SIGNALï¼Œç»™è‡ªå·±å®šä¸€ä¸ªé—¹é’Ÿ</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.AbstractQueuedSynchronizer#parkAndCheckInterrupt</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// æŒ‚èµ·å½“å‰çº¿ç¨‹</span></span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">  	<span class="comment">// æ³¨æ„ï¼LockSupport.park(this)æ‰§è¡Œå®Œæˆåçº¿ç¨‹å°±è¢«æŒ‚èµ·äº†ï¼Œ</span></span><br><span class="line">  	<span class="comment">// é™¤éå…¶ä»–çº¿ç¨‹unparkäº†å½“å‰çº¿ç¨‹ï¼Œæˆ–è€…å½“å‰çº¿ç¨‹è¢«ä¸­æ–­äº†ï¼Œ</span></span><br><span class="line">  	<span class="comment">// å¦åˆ™ä»£ç æ˜¯ä¸ä¼šå†å¾€ä¸‹æ‰§è¡Œçš„ï¼Œåé¢çš„Thread.interrupted()ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.AbstractQueuedSynchronizer.Node#predecessor</span></span><br><span class="line"><span class="comment">// TODO è¿™é‡Œéœ€è¦çœ‹ä¸‹ï¼Œå•¥æ—¶å€™ï¼Œprevä¼šæ˜¯nullï¼Ÿ</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> Node <span class="title">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">    Node p = prev;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œåšäº†ä¸ªéç©ºæ ¡éªŒï¼Œä½†æ˜¯çœ‹äº†ä¸‹ä¸Šä¸‹æ–‡ï¼Œnodeåº”è¯¥ä¸ä¼šå‡ºç°ä¸ºnullçš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// æ—¢ç„¶è¦å–æ¶ˆæ’é˜Ÿäº†ï¼Œå°±æŠŠnodeé‡Œç»´æŠ¤çš„çº¿ç¨‹è®¾ç½®ä¸ºnullå§</span></span><br><span class="line">    node.thread = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// è·³è¿‡å·²ç»å–æ¶ˆçš„å‰é©±èŠ‚ç‚¹ï¼Œæ‰¾åˆ°é CANCELLED çš„å‰é©±èŠ‚ç‚¹ï¼Œå¹¶è¿æ¥åˆ°é CANCELLED çš„å‰é©±èŠ‚ç‚¹åé¢</span></span><br><span class="line">    Node pred = node.prev;</span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// æ‰¾åˆ°ä¸Šé¢è·å–åˆ°çš„å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œåº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œè·å¾—çš„predNextä¸ä¸€å®šæ˜¯ä¼ å…¥è¿›æ¥çš„node</span></span><br><span class="line">    Node predNext = pred.next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Can use unconditional write instead of CAS here.</span></span><br><span class="line">    <span class="comment">// After this atomic step, other Nodes can skip past us.</span></span><br><span class="line">    <span class="comment">// Before, we are free of interference from other threads.</span></span><br><span class="line">  	<span class="comment">// </span></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we are the tail, remove ourselves.</span></span><br><span class="line">  	<span class="comment">// å¦‚æœå½“å‰nodeå°±æ˜¯å°¾èŠ‚ç‚¹çš„è¯</span></span><br><span class="line">  	<span class="comment">// compareAndSetTail(node, pred) å°†å°¾èŠ‚ç‚¹è®¾ç½®ä¸ºä¸Šé¢æ‰¾åˆ°çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">  	<span class="comment">// compareAndSetNext(pred, predNext, null) å°†ä¸Šé¢æ‰¾åˆ°çš„å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹è®¾ç½®ä¸ºnull</span></span><br><span class="line">  	<span class="comment">// é€šè¿‡ä¸Šé¢ä¸¤æ­¥æ“ä½œï¼Œå°±æŠŠå‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºäº†æ–°çš„å°¾èŠ‚ç‚¹ï¼Œå¹¶æŠŠå‰é©±èŠ‚ç‚¹åé¢çš„ CANCELLED çš„èŠ‚ç‚¹å…¨éƒ¨å‡ºé˜Ÿäº†</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// èµ°åˆ°è¿™é‡Œå°±è¯´æ˜ï¼Œå½“å‰èŠ‚ç‚¹åé¢è¿˜æœ‰èŠ‚ç‚¹ï¼Œå–æ¶ˆå½“å‰èŠ‚ç‚¹çš„è¯ï¼Œè¦çœ‹çœ‹æ˜¯ä¸æ˜¯è¦å”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">int</span> ws;</span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">            ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">             (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">            pred.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Node next = node.next;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">              	<span class="comment">// èµ°åˆ°è¿™é‡Œå°±è¯´æ˜ï¼Œ</span></span><br><span class="line">              	<span class="comment">// 1.å‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">              	<span class="comment">// 2.å‰é©±èŠ‚ç‚¹çš„ waitStatus ä¹Ÿå·²ç»è®¾ç½®ä¸ºäº† SIGNAL ï¼Œåç»§èŠ‚ç‚¹ä»æŒ‚èµ·å˜ä¸ºå”¤é†’å°±ç­‰å‰é©±èŠ‚ç‚¹æ‹›å‘¼å°±å¥½äº†</span></span><br><span class="line">              	<span class="comment">// 3.å‰é©±èŠ‚ç‚¹çº¿ç¨‹è¿˜åœ¨ï¼Œè¿˜æ²¡å‡ºé˜Ÿ</span></span><br><span class="line">              	<span class="comment">// 4.å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹è¿˜æ²¡å–æ¶ˆ</span></span><br><span class="line">              	<span class="comment">// å¦‚æœä¸Šé¢çš„éƒ½æ»¡è¶³çš„è¯ï¼Œå°±å°†å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æŒ‚åˆ°ä¸Šé¢æ‰¾åˆ°çš„å‰é©±èŠ‚ç‚¹åé¢ï¼Œç­‰æ‹›å‘¼å°±è¡Œ</span></span><br><span class="line">              	<span class="comment">// èµ°åˆ°è¿™ä¸ªåˆ¤æ–­é‡Œ(if (next != null &amp;&amp; next.waitStatus &lt;= 0))ä¹‹åï¼Œå¦‚æœpred == headäº†ï¼Œåº”è¯¥ä¹Ÿæ²¡å…³ç³»</span></span><br><span class="line">              	<span class="comment">// acquiredQueuedé‡Œä¼šè‡ªæ—‹ï¼Œå°è¯•åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œå¹¶å°è¯•åŠ é”ï¼Œä½†æ˜¯é—®é¢˜æ˜¯è°ä¼šæ¥å”¤é†’è¿™é‡Œçš„nextèŠ‚ç‚¹å‘¢ï¼Ÿ</span></span><br><span class="line">              	<span class="comment">// TODO ç•™ä¸ªç–‘é—®</span></span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          	<span class="comment">// å¦‚æœä¸æ˜¯ä¸Šé¢æ‰€è¯´çš„æ¡ä»¶ï¼Œå°±å°†å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹å”¤é†’ï¼Œ</span></span><br><span class="line">          	<span class="comment">// æ²¡æœ‰æ„å¤–çš„è¯ï¼Œå½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹åº”è¯¥è¿˜åœ¨é€šè¿‡parkAndCheckInterrupt()è¢«æŒ‚èµ·åï¼Œè¿˜æ­‡ç€å‘¢</span></span><br><span class="line">          	<span class="comment">// è¿™é‡Œå”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œè®©åç»§èŠ‚ç‚¹å»acquiredQueuedé‡Œå»è‡ªæ—‹ï¼Œå†æ¬¡å°è¯•è·å–é”å»</span></span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line">	</span><br><span class="line">      	<span class="comment">// æœ€åï¼Œå°†å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æŒ‡å‘è‡ªå·±ï¼Œå°±åˆ«å†å¼•ç”¨åˆ«çš„èŠ‚ç‚¹äº†ï¼Œå°±è®©å½“å‰èŠ‚ç‚¹è‡ªå·±å­¤é›¶é›¶å¾…ç€å§ï¼Œä¹Ÿåˆ«å½“è°çš„gc rootäº†</span></span><br><span class="line">        node.next = node; <span class="comment">// help GC</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">    ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">     (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">    pred.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Node next = node.next;</span><br><span class="line">    <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">        compareAndSetNext(pred, predNext, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">è¿™ä¸ª <span class="keyword">if</span> åˆ¤æ–­ç•¥å¤æ‚ï¼Œæ‹†è§£å¼€çœ‹çœ‹éƒ½æ˜¯å•¥</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. pred != head</span><br><span class="line">  å‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. ((ws = pred.waitStatus) == Node.SIGNAL || (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL)))</span><br><span class="line">  å‰é©±èŠ‚ç‚¹çš„ waitStatus æ˜¯ SIGNAL æˆ–è€… å‰é©±èŠ‚ç‚¹ä¸æ˜¯ CANCELLED çŠ¶æ€ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡ŒæˆåŠŸå°†å‰é©±èŠ‚ç‚¹çš„ waitStatus è®¾ç½®ä¸ºäº† SIGNAL</span><br><span class="line">  </span><br><span class="line"><span class="number">3</span>. pred.thread != <span class="keyword">null</span></span><br><span class="line">  å‰é©±èŠ‚ç‚¹é‡Œç»´æŠ¤çš„çº¿ç¨‹ä¸æ˜¯<span class="keyword">null</span>ï¼›çœ‹äº†ä¸‹ä¸Šä¸‹æ–‡ï¼Œåªæœ‰ å¤´èŠ‚ç‚¹head å’Œ CANCELLEDèŠ‚ç‚¹ çš„çº¿ç¨‹ä¸º<span class="keyword">null</span>ï¼›</span><br><span class="line">  è¿™é‡Œè¯´ å‰é©±èŠ‚ç‚¹çš„çº¿ç¨‹ä¸ä¸º<span class="keyword">null</span>ï¼Œå°±æ˜¯è¯´å‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œä¹Ÿä¸æ˜¯å–æ¶ˆç­‰å¾…çš„èŠ‚ç‚¹æ‰è¡Œ</span><br></pre></td></tr></table></figure>


      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/06/30/ReentrantLock-%E9%87%8A%E6%94%BE%E9%94%81/" rel="next" title="ReentrantLock-é‡Šæ”¾é”">
                <i class="fa fa-chevron-left"></i> ReentrantLock-é‡Šæ”¾é”
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/07/04/LoadingCache%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B/" rel="prev" title="LoadingCacheçš„æ„å»ºè¿‡ç¨‹">
                LoadingCacheçš„æ„å»ºè¿‡ç¨‹ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">llrrbaba</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">llrrbaba</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>





  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
